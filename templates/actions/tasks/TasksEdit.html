{*
 * This script should be above everything else so that TaskEdit initialization happens before any plugin code.
 * (Note that DOM is ready anyway since everything is loaded via XHR and executed by jQuery.)
 *}

{$is_page = !$wa->get("is_dialog")}

{$task_uuid = $task.uuid|default:tasksUuid4::generate()}

{$loc = explode('_', $wa->locale())}

<script>
    window.taskLinks = {$links_data|json_encode};
</script>

<script>(function($) { "use strict";
    {if $task.id}
        $.tasks.setTitle({$task.name|json_encode});
    {/if}

    {$_files_hash = md5(uniqid($task.name, true))}

    window.taskEdit = new TaskEdit({
        $task: $(".t-task-page-wrapper"),
        task_id: {$task.id|default:'null'},
        task_uuid: '{$task_uuid}',
        is_page: {if $is_page}true{else}false{/if},
        priority: "{$task.priority}",
        project_color: "{$project.color}",
        project_id: "{$task.project_id}",
        projects_users: {json_encode($projects_users)},
        projects_priority_users: {json_encode($projects_priority_users)},
        files_hash: {$_files_hash|json_encode},
        messages: {
            date_invalid: {_w('Invalid date.')|json_encode}
        }
    });

    $.wa.locale = $.extend($.wa.locale || {}, {
        "unsaved_data": "[`You are about to abandon task editor without saving the task. All unsaved data will be lost. Are you sure?`]",
        "saved_data_draft": "[`You are about to leave the page without saving the task. Are you sure?`]",
        "unsaved_task": "[`There are unsaved task draft.`]",
        "continue_editing": "[`Do you want to continue editing?`]",
        "attach_pl_checklist": "[`To attach a Pocket Lists checklist, save the task first.`]",
    });
})(jQuery);</script>

{strip}

<div class="t-main-wrapper">
    {if $is_page}
        <div class="t-background-wrapper is-shown"></div>
    {/if}

    {* TASK EDIT CONTENT *}
    <div class="t-task-page-wrapper {if $is_page}is-single-page{else}is-dialog-content{/if}">
        <form id="t-edit-task-form" action="?module=tasks&action=save&id={$task.id}" method="post" data-n="{$task.project_id}.{$task.number}">

            <input type="hidden" name="data[uuid]" value="{$task_uuid}" />

            <!-- plugin hook: 'backend_task_edit.%plugin_id.before_header' -->
            {* @event backend_task_edit.%plugin_id%.before_header *}
            {foreach $backend_task_edit as $_}{ifset($_.before_header)}{/foreach}

            {* HEADER *}
            <header class="t-header-wrapper">
                <div class="t-general-menu is-shown">
                    <div class="t-menu-wrapper flexbox space-20 wrap-mobile">

                        {* PROJECT SELECTOR *}
                        <div class="t-menu-item">
                            <div class="dropdown t-custom-select t-project-select" id="projectSelect">
                                <button class="dropdown-toggle button light-gray t-selected-item selected-custom-item js-selected-project">
                                    {$project.icon_html}
                                    <span>{$project.name|escape|truncate:32}</span>
                                </button>
                                <div class="dropdown-body">
                                    <ul class="menu js-project-list">
                                        {foreach $projects as $p}
                                            <li class="t-nav-item">
                                                <a class="set-custom-select js-project-select" href="javascript:void(0);" data-value="{$p.id}" {if !empty($p.color)}data-project_color_class="{$p.color}"{/if}>
                                                    {$p.icon_html}
                                                    <span>{$p.name|escape|truncate:32}</span>
                                                </a>
                                            </li>
                                        {/foreach}
                                    </ul>
                                </div>
                                <input type="hidden" name="data[project_id]" value="{$task.project_id}">
                            </div>
                            <script>
                                ( function($) {
                                    var $dropdown = $("#projectSelect"),
                                        $currentProject = $dropdown.find("li:first a"),
                                        savedProjectId = {$task.project_id};

                                    if (!savedProjectId) {
                                        $dropdown.find('.dropdown-toggle').html($currentProject.html());
                                        $dropdown.find('[name="data[project_id]"]').val($currentProject.data('value'));
                                    }

                                    $dropdown.waDropdown({
                                        hover: true,
                                        items: ".menu > li > a",
                                        change: function(event, target, dropdown) {
                                            $("[name=\"data[project_id]\"]").val( $(target).data("value") );
                                            taskEdit.onProjectChange();

                                            $.tasks.teamList({
                                                container: $('#t-edit-task-form .t-team-list-wrapper'),
                                                targetField: $('#t-edit-task-form [name="data[assigned_contact_id]"]'),
                                                inviteField: $('#t-edit-task-form .t-team-invite'),
                                                projectId: $(target).data("value"),
                                                assignedContactId: {if !empty($task.id)}{$task.assigned_contact_id|default:"\"\""}{else}""{/if},
                                                updateMode: {if !empty($task.id)}true{else}false{/if}
                                            });

                                        }
                                    });
                                })(jQuery);
                            </script>
                        </div>

                        {include file="./includes/TasksTaskMilestoneSelector.inc.html" inline}
                    </div>
                </div>
                <!-- plugin hook: 'backend_task_edit.%plugin_id.header' -->
                {* @event backend_task_edit.%plugin_id%.header *}
                {foreach $backend_task_edit as $_}{ifset($_.header)}{/foreach}

            </header>

            <!-- plugin hook: 'backend_task_edit.%plugin_id.after_header' -->
            {* @event backend_task_edit.%plugin_id%.after_header *}
            {foreach $backend_task_edit as $_}{ifset($_.after_header)}{/foreach}

            {* EDIT CONTENT *}
            <div class="t-task-page-block">

              {* ASSIGN *}
              <div class="t-form-line">
                  <h5 class="heading custom-mb-12 custom-mt-4 custom-ml-8">[`Assign to`]</h5>
                  <div>
                      <input type="hidden" name="data[assigned_contact_id]" value="{$task.assigned_contact_id}">
                      <div class="t-team-list-wrapper"></div>

                      {include file="./includes/TasksEditInviteForm.inc.html" inline}

                      <script>
                          (function ($) {
                              var initialProjectID = $("#projectSelect").find("li:first a").data('value');
                              $.tasks.teamList({
                                  container: $('#t-edit-task-form .t-team-list-wrapper'),
                                  targetField: $('#t-edit-task-form [name="data[assigned_contact_id]"]'),
                                  inviteField: $('#t-edit-task-form .t-team-invite'),
                                  projectId: {if !empty($task.id)}{$task.project_id}{else}initialProjectID{/if},
                                  assignedContactId: {if !empty($task.id)}{$task.assigned_contact_id|default:"\"\""}{else}""{/if},
                                  updateMode: {if !empty($task.id)}true{else}false{/if}
                              });
                          })(jQuery);
                      </script>
                  </div>
              </div>

                <!-- plugin hook: 'backend_task_edit.%plugin_id.before_name' -->
                {* @event backend_task_edit.%plugin_id%.before_name *}
                {foreach $backend_task_edit as $_}{ifset($_.before_name)}{/foreach}

                <div class="t-big-editor-wrapper editor-wrapper-{$task_uuid}">


                    {* NAME && PRIORITY *}
                    <div class="t-form-line t-table-layout">
                        <div class="t-column">
                            <div class="t-task-name-wrapper">
                                <input type="text" name="data[name]" class="t-task-name-input bold" value="{$task.name|escape}" placeholder="[`Task title`]" tabindex="1">

                                {$type_selector_html}

                                <!-- plugin hook: 'backend_task_edit.%plugin_id.name' -->
                                {* @event backend_task_edit.%plugin_id%.name *}
                                {foreach $backend_task_edit as $_}{ifset($_.name)}{/foreach}

                            </div>
                        </div>
                        <div class="t-column t-column-3">

                            <div class="t-priority-changer">
                                <div class="t-slider-wrapper">
                                    <div class="t-priority-slider"></div>
                                    <input class="t-input" type="hidden" name="data[priority]" value="{$task.priority}">
                                </div>
                                <div class="t-priority-text"></div>
                            </div>

                        </div>
                    </div>

                    <!-- plugin hook: 'backend_task_edit.%plugin_id.after_name' -->
                    {* @event backend_task_edit.%plugin_id%.after_name *}
                    {foreach $backend_task_edit as $_}{ifset($_.after_name)}{/foreach}


                    {* EDITOR / DESCRIPTION *}

                    <!-- plugin hook: 'backend_task_edit.%plugin_id.before_description' -->
                    {* @event backend_task_edit.%plugin_id%.before_description *}
                    {foreach $backend_task_edit as $_}{ifset($_.before_description)}{/foreach}

                    <div class="t-form-line t-description-wrapper">
                        <hr>

                        <textarea id="redactor-task-{$task_uuid}" class="t-redactor-task-edit" name="data[text]" placeholder="[`Task summary`]">{$task.text|escape}</textarea>
                        
                        <!-- plugin hook: 'backend_task_edit.%plugin_id.description' -->
                        {* @event backend_task_edit.%plugin_id%.description *}
                        {foreach $backend_task_edit as $_}{ifset($_.description)}{/foreach}

                    </div>

                    <!-- plugin hook: 'backend_task_edit.%plugin_id.after_description' -->
                    {* @event backend_task_edit.%plugin_id%.after_description *}
                    {foreach $backend_task_edit as $_}{ifset($_.after_description)}{/foreach}


                    {* CUSTOM FIELDS *}

                    <!-- plugin hook: 'backend_task_edit.%plugin_id.before_fields' -->
                    {* @event backend_task_edit.%plugin_id%.before_fields *}
                    {foreach $backend_task_edit as $_}{ifset($_.before_fields)}{/foreach}

                    <div class="t-form-line t-attach-wrapper">
                      <div class="t-attach-droparea" id="t-attach-droparea">
                        <div class="t-chips">

                            <div class="t-chip t-due-date-wrapper">
                                <i class="fas fa-flag-checkered"></i>
                                <span>
                                  <input type="text" class="t-datepicker-due-date" value="{$task.due_date|escape|default:'[`Due date`]'}" placeholder="[`Due date`]" style="max-width: 120px;">
                                  <input type="hidden" name="data[due_date]" value="{$task.due_date|escape}">
                                </span>
                            </div>

                            <div class="t-chip">
                                <a>
                                    <i class="fas fa-paperclip"></i>
                                    [`Attach files`]
                                    <input type="file" name="files[]" multiple="true" />
                                </a>
                            </div>

                            <div class="t-chip t-form-line-autocomplete-chip" data-type="hashtag">
                                <a href="javascript:void(0);">
                                    <i class="fas fa-hashtag"></i>
                                    [`Tags and links`]
                                </a>
                            </div>

                            <div class="t-chip t-form-line-autocomplete-chip" data-type="at">
                                <a href="javascript:void(0);">
                                    <i class="fas fa-at"></i>
                                    [`Watchers`]
                                </a>
                            </div>

                            {if $wa->pocketlists}
                            <div class="t-chip">
                                <a class="t-form-line-checklist-chip">
                                    <i class="fas fa-list"></i>
                                    [`Checklist`]
                                </a>
                            </div>
                            {/if} 

                            <div class="t-chip" style="display: none;">
                                <a class="t-form-line-spellcheck-chip" style="display: flex;">
                                    <img src="data:image/svg+xml,%3csvg%20width='16'%20height='16'%20viewBox='0%200%2016%2016'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M8.32594%207.70265C7.97656%207.35329%207.41285%207.34569%207.05419%207.68545L0.468799%2013.819C-0.0347521%2014.296%20-0.0455698%2015.0948%200.444949%2015.5853C0.934984%2016.0753%201.73243%2016.0645%202.20909%2015.5614L8.34314%208.97661C8.6834%208.61748%208.67574%208.05242%208.32594%207.70265Z'%20fill='black'/%3e%3cpath%20d='M2.55008%203.99187C2.58461%203.8699%202.75749%203.8699%202.79201%203.99187L3.24893%205.60604C3.29055%205.75306%203.40545%205.86796%203.55246%205.90957L5.16664%206.36649C5.28861%206.40102%205.28861%206.57389%205.16664%206.60842L3.55246%207.06534C3.40545%207.10695%203.29055%207.22186%203.24893%207.36887L2.79201%208.98304C2.75749%209.10501%202.58461%209.10501%202.55008%208.98304L2.09317%207.36887C2.05155%207.22186%201.93665%207.10695%201.78963%207.06534L0.17546%206.60842C0.0534922%206.57389%200.0534924%206.40102%200.175461%206.36649L1.78963%205.90957C1.93665%205.86796%202.05155%205.75306%202.09317%205.60604L2.55008%203.99187Z'%20fill='%23EE6622'/%3e%3cpath%20d='M5.00052%200.122182C5.02707%200.0302363%205.16006%200.0302364%205.18661%200.122182L5.53809%201.33902C5.5701%201.44985%205.65849%201.53647%205.77158%201.56784L7.01325%201.91228C7.10707%201.93831%207.10707%202.06863%207.01325%202.09466L5.77158%202.43911C5.65849%202.47048%205.5701%202.5571%205.53809%202.66792L5.18661%203.88476C5.16006%203.97671%205.02707%203.97671%205.00052%203.88476L4.64904%202.66792C4.61703%202.5571%204.52864%202.47048%204.41555%202.43911L3.17388%202.09466C3.08006%202.06863%203.08006%201.93831%203.17388%201.91228L4.41555%201.56784C4.52864%201.53647%204.61703%201.44985%204.64904%201.33902L5.00052%200.122182Z'%20fill='%2355DDDD'/%3e%3cpath%20d='M8.73211%2011.8502C8.75813%2011.7583%208.88846%2011.7583%208.91448%2011.8502L9.25893%2013.067C9.2903%2013.1779%209.37692%2013.2645%209.48775%2013.2959L10.7046%2013.6403C10.7965%2013.6663%2010.7965%2013.7967%2010.7046%2013.8227L9.48775%2014.1671C9.37692%2014.1985%209.2903%2014.2851%209.25893%2014.3959L8.91448%2015.6128C8.88846%2015.7047%208.75813%2015.7047%208.73211%2015.6128L8.38766%2014.3959C8.35629%2014.2851%208.26967%2014.1985%208.15884%2014.1671L6.94201%2013.8227C6.85006%2013.7967%206.85006%2013.6663%206.94201%2013.6403L8.15884%2013.2959C8.26967%2013.2645%208.35629%2013.1779%208.38766%2013.067L8.73211%2011.8502Z'%20fill='%23F5C400'/%3e%3cpath%20d='M13.3484%209.16196C13.3813%209.04562%2013.5462%209.04562%2013.5791%209.16196L14.015%2010.7016C14.0547%2010.8419%2014.1643%2010.9515%2014.3045%2010.9912L15.8442%2011.427C15.9605%2011.4599%2015.9605%2011.6248%2015.8442%2011.6578L14.3045%2012.0936C14.1643%2012.1333%2014.0547%2012.2429%2014.015%2012.3831L13.5791%2013.9228C13.5462%2014.0391%2013.3813%2014.0391%2013.3484%2013.9228L12.9125%2012.3831C12.8728%2012.2429%2012.7633%2012.1333%2012.623%2012.0936L11.0833%2011.6578C10.967%2011.6248%2010.967%2011.4599%2011.0833%2011.427L12.623%2010.9912C12.7633%2010.9515%2012.8728%2010.8419%2012.9125%2010.7016L13.3484%209.16196Z'%20fill='%2322CC22'/%3e%3cpath%20d='M10.7288%200.228994C10.7952%20-0.00536791%2011.1274%20-0.00536752%2011.1937%200.228994L12.0717%203.33062C12.1516%203.61311%2012.3724%203.83389%2012.6549%203.91386L15.7565%204.79183C15.9909%204.85816%2015.9909%205.19035%2015.7565%205.25669L12.6549%206.13466C12.3724%206.21462%2012.1516%206.4354%2012.0717%206.71789L11.1937%209.81952C11.1274%2010.0539%2010.7952%2010.0539%2010.7288%209.81952L9.85087%206.71789C9.77091%206.4354%209.55012%206.21462%209.26763%206.13466L6.16601%205.25669C5.93164%205.19035%205.93164%204.85816%206.16601%204.79183L9.26763%203.91386C9.55012%203.83389%209.77091%203.61311%209.85087%203.33062L10.7288%200.228994Z'%20fill='%230088EE'/%3e%3c/svg%3e" class="tw-cursor-pointer" style="width: 20px; height: 20px; margin-right: 3px;">
                                    [`Spellcheck`]
                                </a>
                            </div>

                    

                            {$task_ext_html}

                            <!-- plugin hook: 'backend_task_edit.%plugin_id.more' -->
                            {* @event backend_task_edit.%plugin_id%.more *}
                            {foreach $backend_task_edit as $_}{ifset($_.more)}{/foreach}

                        </div>
                      </div>

                    </div>

                    <!-- plugin hook: 'backend_task_edit.%plugin_id.after_fields' -->
                    {* @event backend_task_edit.%plugin_id%.after_fields *}
                    {foreach $backend_task_edit as $_}{ifset($_.after_fields)}{/foreach}

                </div>



                {* ATTACHMENTS *}

                <!-- plugin hook: 'backend_task_edit.%plugin_id.before_attachments' -->
                {* @event backend_task_edit.%plugin_id%.before_attachments *}
                {foreach $backend_task_edit as $_}{ifset($_.before_attachments)}{/foreach}

                <div class="t-form-line t-attach-wrapper">

                    {* Container For Attached Files*}
                    <div class="t-attached-files-wrapper {if !empty($task.attachments)}is-shown{/if}" id="t-attached-files-wrapper">
                        <div class="t-images-list">

                            {foreach $task.images as $image}
                                <div class="t-image-item" data-file-ident="{$image.id}">
                                    <a class="t-image-link" href="?module=attachments&action=download&id={$image.id}" title="{$image.name|escape}">
                                        <img src="?module=attachments&action=download&id={$image.id}" alt="{$image.name|escape}">
                                    </a>
                                    <div class="t-file-name">{$image.name|escape}</div>
                                    <div class="t-file-size">{$image.size|wa_format_file_size}</div>
                                    <a class="t-file-delete" href="javascript:void(0);"></a>
                                </div>
                            {/foreach}

                            <div class="t-image-item is-template">
                                <div class="t-image-link">
                                    <img src="" alt="">
                                </div>
                                <div class="t-file-name"></div>
                                <div class="t-file-size"></div>
                                <a class="t-file-delete" href="javascript:void(0);"></a>
                                <div class="t-file-error"></div>
                            </div>
                        </div>
                        <div class="t-files-list">
                            {foreach $task.files as $file}
                                <div class="t-file-item" data-file-ident="{$file.id}">
                                    <a class="t-file-link" href="?module=attachments&action=download&id={$file.id}" title="{$file.name|escape}">
                                        <i class="fas fa-paperclip custom-mr-4"></i>
                                        <span class="t-file-name">{$file.name|escape}</span>
                                        <span class="t-file-size nowrap">{$file.size|wa_format_file_size}</span>
                                    </a>
                                    <a class="t-file-delete" href="javascript:void(0);"></a>
                                </div>
                            {/foreach}

                            <div class="t-file-item is-template">
                                <div class="t-file-link">
                                    <i class="fas fa-paperclip custom-mr-4"></i>
                                    <span class="t-file-name"></span>
                                    <span class="t-file-size nowrap"></span>
                                </div>
                                <a class="t-file-delete" href="javascript:void(0);"></a>
                                <div class="t-file-error"></div>
                            </div>
                        </div>
                    </div>

                    <!-- plugin hook: 'backend_task_edit.%plugin_id.attachments' -->
                    {* @event backend_task_edit.%plugin_id%.attachments *}
                    {foreach $backend_task_edit as $_}{ifset($_.attachments)}{/foreach}

                </div>

                <!-- plugin hook: 'backend_task_edit.%plugin_id.after_attachments' -->
                {* @event backend_task_edit.%plugin_id%.after_attachments *}
                {foreach $backend_task_edit as $_}{ifset($_.after_attachments)}{/foreach}


                {* BUTTONS *}

                <!-- plugin hook: 'backend_task_edit.%plugin_id.before_buttons' -->
                {* @event backend_task_edit.%plugin_id%.before_buttons *}
                {foreach $backend_task_edit as $_}{ifset($_.before_buttons)}{/foreach}

                <div class="t-errors-block js-errors-block"></div>
                <div class="t-form-line t-buttons-block flexbox middle space-8">
                    <button class="button green large t-save-task-link" type="submit">{if !empty($task.id)}[`Save task`]{else}[`Create task`]{/if}</button>
                    <a class="t-close-link button large light-gray" href="javascript:void(0);">[`Cancel`]</a>

                    <!-- plugin hook: 'backend_task_edit.%plugin_id.buttons' -->
                    {* @event backend_task_edit.%plugin_id%.buttons *}
                    {foreach $backend_task_edit as $_}{ifset($_.buttons)}{/foreach}

                </div>

                <!-- plugin hook: 'backend_task_edit.%plugin_id.after_buttons' -->
                {* @event backend_task_edit.%plugin_id%.after_buttons *}
                {foreach $backend_task_edit as $_}{ifset($_.after_buttons)}{/foreach}

            </div>
        </form>
    </div>
</div>

<script>
(function () {
    if (!lexicalEditor) return;

    const $el = $('#redactor-task-{$task_uuid}');
    const $spellcheckBtn = $('.t-form-line-spellcheck-chip');
    const $spellcheckBtnParent = $spellcheckBtn.parent();

    window.waRedactorTaskInit = () => {
        $el.parent().find('.lexical-editor').remove();

        lexicalEditor.createLexicalInstance({
            el: $el[0],
            isRichMode: TasksController ? TasksController.options.text_editor === 'wysiwyg' : false,
            taskId: '{$task.id}',
            storage: taskEdit ? (taskEdit.is_new ? (TasksController ? TasksController.getDraftKeyTaskText() : '') : '') : '',
            placeholder: '[`Task summary`]',
            imageUploadUrl: '?module=attachments&action=imageUpload',
            imageUploadTaskUuid: '{$task_uuid}',
            controls: document.querySelector('.editor-wrapper-{$task_uuid}'),
            mentions: window.taskLinks || {},
            mentionsFetchUrlWA: true,
            lang: '{$loc[0]}'
        });

        TasksController.storageDataInMdMode($el[0], 'getDraftKeyTaskText');
    };

    function runSpellCheck () {
        if (!window.spellCheck) return;
        const text = $el.val();
        window.spellCheck(text).then((correctedText) => {
            $el.val(correctedText).trigger('input').trigger('change');
            waRedactorTaskInit();
        });
    };

    function checkLength () {
        const charCount = $el.val().length;
        $spellcheckBtnParent.hide();
        if (charCount > 10) {
            $spellcheckBtnParent.show();
        }
    }

    waRedactorTaskInit();
    checkLength();

    $spellcheckBtn.on('click', function (e) {
        e.preventDefault();
        runSpellCheck();
    });

    $el.on('input', checkLength);

})();
</script>

{/strip}
